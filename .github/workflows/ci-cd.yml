name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  laravel-ci-cd:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: titanhub
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # 1. سحب المشروع
      - uses: actions/checkout@v3

      # 2. تجهيز PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_mysql, xml, ctype, curl, tokenizer, dom, redis

      # 3. تثبيت Composer
      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-progress

      # 4. نسخ env
      - name: Copy .env
        run: cp .env.example .env

      - name: Set environment variables
        run: |
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=titanhub" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env

      # 5. انتظار Docker Services
      - name: Wait for DB & Redis
        run: |
          for i in {1..20}; do
            nc -z 127.0.0.1 3306 && echo "MySQL is ready" && break
            echo "Waiting for MySQL..." && sleep 2
          done
          for i in {1..20}; do
            nc -z 127.0.0.1 6379 && echo "Redis is ready" && break
            echo "Waiting for Redis..." && sleep 2
          done

      # 6. إنشاء key
      - name: Generate App Key
        run: php artisan key:generate

      # 7. الميجريشن
      - name: Run Migrations
        run: php artisan migrate --force

      # 8. تشغيل الاختبارات
      - name: Run Tests
        run: php artisan test

      # 9. Build Docker Image (CI)
      - name: Build Docker Image
        run: docker build -t titanhub-app .

      # 10. رفع Image لو عندك Docker Hub (CD)
#      - name: Login to Docker Hub
#        if: github.ref == 'refs/heads/main'
#        uses: docker/login-action@v2
#        with:
#          username: ${{ secrets.DOCKER_HUB_USERNAME }}
#          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
#
#      - name: Push Docker Image
#        if: github.ref == 'refs/heads/main'
#        run: |
#          docker tag titanhub-app ${{ secrets.DOCKER_HUB_USERNAME }}/titanhub-app:latest
#          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/titanhub-app:latest
